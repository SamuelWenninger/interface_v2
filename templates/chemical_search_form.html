{% extends "base.html" %}
{% block body %}
<div id="spinner" class="spinner" style="display:none;">
    <img id="img-spinner" src="/static/images/ajax-loader.gif" alt="Loading"/>
</div>

  <div id = "search-options" class="panel panel-default">
    <div id = "search-panel" class="panel-heading" data-toggle="collapse" data-parent="#accordion"  onclick="$('#collapseOne').collapse('toggle'); $('#collapseTwo').collapse('toggle');">
      <h4 class="panel-title">
        <a class='accordion-toggle' href="">
          Search Options
        </a>
      </h4>
    </div>
    <div id="collapseOne" class="panel-collapse collapse in">
      <div class="panel-body">
        
<ul class="nav nav-tabs" id="myTab">
  <li class= "active"><a href="#minerals">Minerals</a></li>
  <li><a href="#chemistry">Elements and Oxides</a></li>
</ul>
<div id = "form-container">
    <form action="" method="get" id='content' class="tab-content">

    <div class="tab-pane active" id="minerals"><br>
       <label for="mineral-tree">Mineral: </label>
       <div id="mineral-select">
       <select multiple id="selected-mineral" name="minerals__in" onchange="updateMineral()" class="chosen-select">
         <option></option>
          {% for m in minerals %}
              <option value="{{ m.id }}">{{ m.name }}</option>
          {% endfor %}
       </select>
       </div>
    </div>

   <div class="tab-pane" id="chemistry"><br><br>
    <div style="float:left;margin-top:-20px">
      <label for="mineral-tree">Elements: </label>
       <div id="mineral-select">
       <select multiple id="selected-elements" name="elements__element_id__in" onchange="updateChemistry()" class="chosen-select">
         <option></option>
          {% for e in elements %}
              <option value="{{ e.element_id }}">{{ e.name }}</option>
          {% endfor %}
       </select>
       </div>
    </div>
    <div style="margin-left:40px;float:left;margin-top:-20px">
       <label for="mineral-tree">Oxides: </label>
       <div id="mineral-select">
       <select multiple id="selected-oxides" name="oxides__oxide_id__in" onchange="updateChemistry()" class="chosen-select">
         <option></option>
          {% for o in oxides %}
              <option value="{{ o.oxide_id }}">{{ o.species }}</option>
          {% endfor %}
       </select>
       </div>
    </div>

       </div> <!--end form1 -->
       </div> <!--end chemistry-forms -->
       

       <div id = "selected-minerals"></div>

      </div><!-- end chemistry-->

<div class="clear"></div>

</div><!--end form container-->
  {% if error %}
      <p style="color: red;">Please submit a search term.</p>
  {% endif %}
      </div>
    </div>
  </div>

<div id="search-summary" class="panel panel-default">
    <div class="panel-heading" onclick="$('#collapseOne').collapse('toggle'); $('#collapseTwo').collapse('toggle');">
      <h4 class="panel-title">
        <a class='accordion-toggle' data-toggle="collapse" data-parent="#accordion" href="">
          Search Summary
        </a>
      </h4>
      <a id= "clearAll" onclick="clearAll()">Clear All</a>
    
     </div>
    <div id="collapseTwo" class="panel-collapse collapse in">
       <div class="panel-body">
          <p id= "instructions">Set your search criteria by selecting from the categories on the left.<br></p>
	        <div id = "search-options-minerals"></div>
          <div id = "search-options-chemistry"></div>
                <div id = "form-submit">


<div id = "resource" class = "text-center">
    <div class="btn-group" data-toggle="buttons" style="margin:0 auto;">
        <label class="btn btn-primary">
            <input type="radio" name="resource" value="sample" onchange="$('#collapseFour').collapse('toggle');" id="option1"> View Samples
        </label>
        <label class="btn btn-primary active">
            <input type="radio" name="resource" value="chemicalanalysis" onchange="$('#collapseFour').collapse('toggle');" id="option2" checked="checked"> View Chemical Analyses
        </label>
    </div>
</div>

</div>
<div id="collapseFour" class="panel-collapse collapse in">
  <br>
  <input type="checkbox" id="showall" name="all_results" value="yes">Display all results</input>&nbsp;&nbsp;&nbsp;&nbsp;
  <!-- <input type="checkbox" id="showmap" onchange="$('#collapseThree').collapse('toggle');" name="showmap" value="ofcourse">Show on map</input> -->
</div>
  <br>
  <input type="submit" onclick="$('#collapseOne').collapse('toggle'); $('#collapseTwo').collapse('toggle');" value="Search">
      </div>
       </div>
    </div><!--end collapsetwo -->
</div>

  </form>  <!-- tabs -->

<div class="clear"></div>

<div id = "results"></div>


<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=drawing"></script>
<script src="/static/js/jquery-2.1.1.min.js"></script>

<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="/static/css/chosen.min.css">
<script src="/static/js/chosen.jquery.min.js"></script>
<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>

<link rel="stylesheet" href="/static/css/style.min.css">
<script src="/static/js/jstree.min.js"></script>
<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">
<link href="/static/css/bootstrap-switch.min.css" rel="stylesheet">
<script src="/static/css/bootstrap-switch.min.js"></script>

<script>
$('#myTab a').click(function (e) {
  e.preventDefault();
  $(this).tab('show');
});

$('#location-tab a').click(function (e) {
  e.preventDefault();
  $(this).tab('show');
});

//GLOBAL VARS
var currentOverlay = null;
var chemistryRows = 2;

//ON READY FUNCTION
$(function()
{
var mineralnodes = {{ mineral_nodes|safe }};
console.log(mineralnodes);

$('#mineral-tree').jstree({ 'core' : {
    'data' : mineralnodes
}
,

"checkbox" : {
      "keep_selected_style" : false
    },
    "plugins" : [ "checkbox" ]
 });


//Ajax call to update sample data
var frm = $('#content');
    frm.submit(function () {
    $('#spinner').show();
        $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            data: frm.serialize(),
            success: function (data) {
                $("#results").html("");
                $("#results").html(data);
                $('#spinner').hide();
                if(document.getElementsByTagName("header")[1])
                 document.getElementsByTagName("header")[1].innerHTML = "";
            },
            error: function(data) {
                $("#results").html("Error");
                $('#spinner').hide();
            }
        });
        return false;
    }); //END ajax

$('.btn-toggle').click(function() {
    $(this).find('.btn').toggleClass('active');  
    

   $(this).find('.btn').toggleClass('btn-primary');

    $(this).find('.btn').toggleClass('btn-default');
       
});

$("#form1 .chosen-select").chosen({
    allow_single_deselect: true,
    disable_search_threshold: 10,
    no_results_text: "Oops, nothing found!",
    width: "50%"
  });

$("#mineral-select .chosen-select").chosen({
    allow_single_deselect: true,
    disable_search_threshold: 10,
    no_results_text: "Oops, nothing found!",
    width: "50%"
  });
}); //END READY FUNCTION

function updateChemistry()
{
 //Chemistry search options, selected chemistry minerals
  var searchOptions = document.getElementById("search-options-chemistry");
 searchOptions.innerHTML = "";

 if ($("#selected-elements option:selected").length || $("#selected-oxides option:selected").length)
  searchOptions.innerHTML += "<div class = 'summary-title'><h4>Chemistry (all) </h4><a onclick='clearChemistry()' class='clear-title'>Clear</a></div>";

 if ($("#selected-elements option:selected").length + $("#selected-oxides option:selected").length > 1)
  document.getElementById("showall").checked = "checked";
 
 if($("#selected-elements option:selected").length)
  {
   for(var a = 0; a < $("#selected-elements option:selected").length; a++)
   {
   if($("#selected-elements option:selected")[a].selected)
    var nextMineral = $("#selected-elements option:selected")[a].innerHTML + ", ";
    if(nextMineral !== ", ")
      searchOptions.innerHTML += $("#selected-elements option:selected")[a].innerHTML + ", ";
    console.log("JUST ADDED " + nextMineral);
   }
   var s = searchOptions.innerHTML;
   searchOptions.innerHTML = s.slice(0, -2);
   searchOptions.innerHTML += "<br>";
  }

  if($("#selected-oxides option:selected").length)
  {
   for(var a = 0; a < $("#selected-oxides option:selected").length; a++)
   {
   if($("#selected-oxides option:selected")[a].selected)
    var nextMineral = $("#selected-oxides option:selected")[a].innerHTML + ", ";
    if(nextMineral !== ", ")
      searchOptions.innerHTML += $("#selected-oxides option:selected")[a].innerHTML + ", ";
    console.log("JUST ADDED " + nextMineral);
   }
   var s = searchOptions.innerHTML;
   searchOptions.innerHTML = s.slice(0, -2);
   searchOptions.innerHTML += "<br>";
  }
}

function clearChemistry()
{
 var searchOptions = document.getElementById("search-options-chemistry");
 searchOptions.innerHTML = "";
 $("#chemistry .chosen-select").val('').trigger("chosen:updated");
}

function updateMineral()
{
 var searchOptions = document.getElementById("search-options-minerals");
 searchOptions.innerHTML = "";
 
 if($("#selected-mineral option:selected").length)
  {
   searchOptions.innerHTML += "<div class = 'summary-title'><h4>Mineral (any) </h4><a onclick='clearMineral()' class='clear-title'>Clear</a></div>";
   for(var a = 0; a < $("#selected-mineral option:selected").length; a++)
   {
   if($("#selected-mineral option:selected")[a].selected)
    var nextMineral = $("#selected-mineral option:selected")[a].innerHTML + ", ";
    if(nextMineral !== ", ")
      searchOptions.innerHTML += $("#selected-mineral option:selected")[a].innerHTML + ", ";
    console.log("JUST ADDED " + nextMineral);
   }
   var s = searchOptions.innerHTML;
   searchOptions.innerHTML = s.slice(0, -2);
   searchOptions.innerHTML += "<br>";
  }
}
function clearMineral()
{
 var searchOptions = document.getElementById("search-options-minerals");
 searchOptions.innerHTML = "";
 $("#mineral-select .chosen-select").val('').trigger("chosen:updated");
}

function clearAll()
{
 clearChemistry();
 clearMineral();
}

// function addChemistryRow()
// {
//  var mineralnodes = {{ mineral_nodes|safe }};
//  var rows = document.getElementById("chemistry-forms");
//  var div = document.createElement("div");
//  div.id = "form" + chemistryRows;
//  div.className = "chemistry-form";

//  //Squirrel
//  //<input type="hidden" name="squirrel" value="squirrel">
//  var squirrel = document.createElement("input");
//  squirrel.value = "squirrel";
//  squirrel.type = "hidden";
//  squirrel.name = "squirrel";
//  div.appendChild(squirrel);

//  //Element Oxide select
//  var eloroxSelect = document.createElement("select");
//  eloroxSelect.className = "elementoroxide";
//  //eloroxSelect.onchange = renderElementOxideList(this);
//  var option1 = document.createElement("option");
//  var option1Text = document.createTextNode("Element");
//  var option2 = document.createElement("option");
//  var option2Text = document.createTextNode("Oxide");
//  option1.appendChild(option1Text);
//  option2.appendChild(option2Text);
//  eloroxSelect.appendChild(option1);
//  eloroxSelect.appendChild(option2);
//  div.appendChild(eloroxSelect);
//  var br = document.createElement("br");
//  br.className = "br";
//  div.appendChild(br);

//  //Element Oxide list
//  var innerDiv = document.createElement("div");
//  innerDiv.className = "elementoxidelist";
//  var valueSelect = document.createElement("select");
//  valueSelect.name = "elements__element_id__in";
//  valueSelect.onchange = "";
//  valueSelect.className = "chosen-select elorox";

//  {% for element in elements %}
//    var newOption = document.createElement("option");
//    var newOptionText = document.createTextNode("{{element.name}}");
//    newOption.value = "{{element.element_id}}";
//    newOption.appendChild(newOptionText);
//    valueSelect.appendChild(newOption);
//  {% endfor %}

//  innerDiv.appendChild(valueSelect);
//  div.appendChild(innerDiv);
 
//  //Add and Remove anchors
//  var add = document.createElement("a");
//  add.className = "add";
//  var addText = document.createTextNode("Add");
//  add.appendChild(addText);
//  div.appendChild(add);
 
//  var remove = document.createElement("a");
//  remove.className = "remove";
//  //remove.onclick = removeChemistryRow(this.parentNode.id);
//  var removeText = document.createTextNode("Remove");
//  remove.appendChild(removeText);
//  div.appendChild(remove);
//   var br2 = document.createElement("br");
//  div.appendChild(br2);

//  //Append new div to rows
//  rows.appendChild(div);
  
 
//  //rows.innerHTML += "<div id= 'form" + chemistryRows + "'><select class='elementoroxide' onchange='renderElementOxideList(this)'><option selected='selected' value='element'>Element</option><option value='oxide'>Oxide</option></select><br><div class = 'elementoxidelist'><select name='elements__element_id__in' onchange='' class='chosen-select elorox'>{% for element in elements %}<option value='{{ element.element_id }}'>{{ element.name }}</option>{% endfor %}</select></div><a class='add' onclick='addChemistryRow()'>Add</a><a class='remove' onclick='removeChemistryRow(this.parentNode.id)'>Remove</a><br></div> <!--end form -->";

// console.log(chemistryRows);
// //Chosen-select plugin activate
// $("#form" + chemistryRows + " .chosen-select").chosen({
//     disable_search_threshold: 10,
//     no_results_text: "Oops, nothing found!",
//     width: "50%"
//   });

// chemistryRows++;
// }

// $('#chemistry').click(function(e){
// updateChemistry();
// });

// $('#chemistry-forms').click(function(e){
//        var elem = e.target;
//        if(elem.className == "add")
//         addChemistryRow();
//        else if(elem.className == "add addFirst")
//        {
//         removeAddFirst();
//         addChemistryRow();
//        }
//        else if(elem.className == "remove")
//         removeChemistryRow(elem.parentNode.id);
// });

// function removeAddFirst()
// {
//  var addFirst = document.getElementsByClassName("addFirst")[0];
//  addFirst.parentNode.removeChild(addFirst);
// }

// $('#chemistry-forms').change(function(e){
//        var elem = e.target;
//        if(elem.className == "elementoroxide")
//        {
//          console.log(elem.options[elem.selectedIndex].value);
//           var list = $($(elem).parent()[0]).find(".elementoxidelist")[0];
//           elem.parentNode.removeChild(list); 
//           var oldadd = $($(elem).parent()[0]).find(".add")[0];
//           elem.parentNode.removeChild(oldadd);
//           var oldremove = $($(elem).parent()[0]).find(".remove")[0];
//           elem.parentNode.removeChild(oldremove);
//           //var oldbr = $($(elem).parent()[0]).find(".br")[0];
//           //elem.parentNode.removeChild(oldbr);
//           var id = elem.parentNode.id;
//           $("#" + id + " br:lt(1)").remove();

//          //Element Oxide list
//          var innerDiv = document.createElement("div");
//          innerDiv.className = "elementoxidelist";
//          var valueSelect = document.createElement("select");
//          valueSelect.className = "chosen-select";

//          if(elem.options[elem.selectedIndex].text == "Oxide")
//          {
//           valueSelect.name = "oxides__oxide_id__in";
//           {% for oxide in oxides %}
//            var newOption = document.createElement("option");
//            var newOptionText = document.createTextNode("{{oxide.species}}");
//            newOption.value = "{{oxide.oxide_id}}";
//            newOption.appendChild(newOptionText);
//            valueSelect.appendChild(newOption);
//           {% endfor %}
//          }
//          else if(elem.options[elem.selectedIndex].text == "Element")
//          {
//           valueSelect.name = "elements__element_id__in";
//           {% for element in elements %}
//            var newOption = document.createElement("option");
//            var newOptionText = document.createTextNode("{{element.name}}");
//            newOption.value = "{{element.element_id}}";
//            newOption.appendChild(newOptionText);
//            valueSelect.appendChild(newOption);
//           {% endfor %}
//          }
//         innerDiv.appendChild(valueSelect);
//         elem.parentNode.appendChild(innerDiv);

//          //Add and Remove anchors
//          var add = document.createElement("a");
//          add.className = "add";
//          var addText = document.createTextNode("Add");
//          add.appendChild(addText);
//          elem.parentNode.appendChild(add);
 
//          var remove = document.createElement("a");
//          remove.className = "remove";
//          var removeText = document.createTextNode("Remove");
//          remove.appendChild(removeText);
//          elem.parentNode.appendChild(remove);
//          var br2 = document.createElement("br");
//          elem.parentNode.appendChild(br2);


// $(elem.parentNode).find(".chosen-select").chosen({
//     disable_search_threshold: 10,
//     no_results_text: "Oops, nothing found!",
//     width: "50%"
//   });
//        }
// });

// function renderElementOxideList(elem)
// {
//  //Clear element/oxide list
//  var list = $($(elem).parent()[0]).find(".elementoxidelist")[0];
//  console.log(list);
//  list.innerHTML = "";

//  //Render elements
//  if($(elem).val() == "element")
//   list.innerHTML = "<select name='elements__element_id__in' onchange='' class='chosen-select elorox'>{% for element in elements %}<option value='{{ element.element_id }}'>{{ element.name }}</option>{% endfor %}</select>";
//  //Render oxides
//  else if($(elem).val() == "oxide")
//   list.innerHTML = "<select name='oxides__oxide_id__in' onchange='' class='chosen-select elorox'>{% for oxide in oxides %}<option value='{{ oxide.oxide_id }}'>{{ oxide.species }}</option>{% endfor %}</select>";

//  //Call chosen plugin
//  //Chosen-select plugin activate
// /*$(list).find(".elorox").chosen({
//     disable_search_threshold: 10,
//     no_results_text: "Oops, nothing found!",
//     width: "50%"
//   });*/
// }

// function removeChemistryRow(id)
// {
//  var element = document.getElementById(id);
//  element.parentNode.removeChild(element);

//  if(document.getElementsByClassName("elementoroxide").length < 1)
//  {
//   console.log("Add ADD button");
//   var chemistryForm = document.getElementById("chemistry-forms");
//   //Add ADD chemistry row button
//   var add = document.createElement("a");
//   add.className = "add";
//   add.className += " addFirst";
//   var addText = document.createTextNode("Add");
//   add.appendChild(addText);
//   chemistryForm.appendChild(add);
  
//  }
// }

function HomeControl(controlDiv, map) {

  // Set CSS styles for the DIV containing the control
  // Setting padding to 5 px will offset the control
  // from the edge of the map

  // Set CSS for the control border
  var controlUI = document.createElement('div');
  controlUI.style.backgroundColor = 'white';
  controlUI.style.cursor = 'pointer';
  controlUI.style.textAlign = 'center';
  controlUI.title = 'Clear selection';
  controlUI.id = 'clear-map';
  controlDiv.appendChild(controlUI);

  // Set CSS for the control interior
  var controlText = document.createElement('div');
  controlText.style.fontFamily = 'Arial,sans-serif';
  controlText.style.fontSize = '12px';
  controlText.style.paddingLeft = '4px';
  controlText.style.paddingRight = '4px';
  controlText.innerHTML = '<b>Clear </b>';
  controlUI.appendChild(controlText);

  // Setup the click event listeners: simply set the map to
  // Chicago
  google.maps.event.addDomListener(controlUI, 'click', function() {
    clearBounds();
  });

}
</script>

{% endblock %}
